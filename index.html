<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>Water Meter Reads</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: light dark; }
    body { background: radial-gradient(1200px 800px at 30% -10%, #e6f0ff 0%, #ffffff 45%) no-repeat; }
    @media (prefers-color-scheme: dark) {
      body { background: radial-gradient(1200px 800px at 30% -10%, #0b1220 0%, #0e1628 45%) no-repeat; }
    }
    .card { backdrop-filter: saturate(1.2) blur(8px); }
    .modal-show { display: flex !important; }
    .safe-pad { padding-bottom: max(16px, env(safe-area-inset-bottom)); }
    .tap { -webkit-tap-highlight-color: transparent; }
  </style>
</head>
<body class="min-h-screen text-slate-800 dark:text-slate-100 tap">
  <div class="mx-auto max-w-4xl px-4 pt-6 pb-24 safe-pad">
    <!-- Community Selection Screen -->
    <div id="communitySelection" class="min-h-screen flex flex-col items-center justify-center">
      <header class="text-center mb-12">
        <h1 class="text-4xl font-bold tracking-tight text-slate-800 dark:text-slate-200 mb-4">Water Meter Management</h1>
        <p class="text-lg text-slate-600 dark:text-slate-400">Select a community to manage water meter readings</p>
      </header>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl">
        <!-- Mesa Del Toro Card -->
        <div class="community-card group cursor-pointer" data-community="mesa-del-toro">
          <div class="card rounded-3xl bg-gradient-to-br from-indigo-500 to-purple-600 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-8 text-white hover:shadow-2xl transition-all duration-300 transform hover:scale-105">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-2xl font-bold">Mesa Del Toro</h2>
              <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                </svg>
              </div>
            </div>
            <p class="text-indigo-100 mb-6">Manage water meter readings for Mesa Del Toro community</p>
            <div class="flex items-center text-sm text-indigo-200">
              <span>View Community</span>
              <svg class="w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </div>
          </div>
        </div>

        <!-- Alba Card -->
        <div class="community-card group cursor-pointer" data-community="alba">
          <div class="card rounded-3xl bg-gradient-to-br from-emerald-500 to-teal-600 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-8 text-white hover:shadow-2xl transition-all duration-300 transform hover:scale-105">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-2xl font-bold">Alba</h2>
              <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                </svg>
              </div>
            </div>
            <p class="text-emerald-100 mb-6">Manage water meter readings for Alba community</p>
            <div class="flex items-center text-sm text-emerald-200">
              <span>View Community</span>
              <svg class="w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </div>
          </div>
        </div>

        <!-- Lhoist Card -->
        <div class="community-card group cursor-pointer" data-community="lhoist">
          <div class="card rounded-3xl bg-gradient-to-br from-orange-500 to-red-600 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-8 text-white hover:shadow-2xl transition-all duration-300 transform hover:scale-105">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-2xl font-bold">Lhoist</h2>
              <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                </svg>
              </div>
            </div>
            <p class="text-orange-100 mb-6">Manage water meter readings for Lhoist community</p>
            <div class="flex items-center text-sm text-orange-200">
              <span>View Community</span>
              <svg class="w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </div>
          </div>
        </div>

        <!-- Linda Vista Card -->
        <div class="community-card group cursor-pointer" data-community="linda-vista">
          <div class="card rounded-3xl bg-gradient-to-br from-cyan-500 to-blue-600 shadow-xl ring-1 ring-black/5 dark:ring-white/10 p-8 text-white hover:shadow-2xl transition-all duration-300 transform hover:scale-105">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-2xl font-bold">Linda Vista</h2>
              <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                </svg>
              </div>
            </div>
            <p class="text-cyan-100 mb-6">Manage water meter readings for Linda Vista community</p>
            <div class="flex items-center text-sm text-cyan-200">
              <span>View Community</span>
              <svg class="w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Community Dashboard (Hidden by default) -->
    <div id="communityDashboard" class="hidden">
      <!-- Back Button -->
      <div class="mb-6">
        <button id="backToCommunities" class="flex items-center gap-2 text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
          <span>Back to Communities</span>
        </button>
      </div>

      <!-- Chart Card -->
      <section id="communitySection" class="card rounded-3xl bg-white/80 dark:bg-slate-800/60 shadow-lg ring-1 ring-black/5 dark:ring-white/10 p-4 sm:p-6">
      <div class="mb-4">
        <h1 class="text-2xl font-bold text-slate-800 dark:text-slate-200 mb-1">Mesa Del Toro</h1>
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-lg font-semibold">Reads by Location</h2>
            <p class="text-sm text-slate-500 dark:text-slate-400">Live updates from Firebase</p>
          </div>
          <div class="text-sm">
            <label class="mr-2 align-middle">Range:</label>
            <select id="rangeSelect"
              class="align-middle rounded-xl bg-white/70 dark:bg-slate-900/40 px-3 py-1.5 text-sm ring-1 ring-slate-200 dark:ring-slate-700 focus:outline-none">
              <option value="all" selected>All time</option>
              <option value="90">Last 90 days</option>
              <option value="30">Last 30 days</option>
              <option value="7">Last 7 days</option>
            </select>
          </div>
        </div>
      </div>

      <div class="relative">
        <canvas id="readsChart" height="220" class="!h-[48vh] sm:!h-[42vh]"></canvas>
      </div>

      <!-- Legend -->
      <div id="legend" class="mt-4 grid grid-cols-2 gap-2 sm:grid-cols-3"></div>

      <!-- Action buttons live UNDER the graph -->
      <div class="mt-5 space-y-3">
        <button id="addBtn"
          class="w-full rounded-2xl bg-indigo-600 px-4 py-3 text-white font-semibold shadow hover:bg-indigo-500 active:scale-[0.99]">
          Add Water Meter Data
        </button>
        <button id="editLocationBtn"
          class="w-full rounded-2xl bg-purple-600 px-4 py-3 text-white font-semibold shadow hover:bg-purple-500 active:scale-[0.99]">
          Edit Location Data
        </button>
        <button id="exportBtn"
          class="w-full rounded-2xl bg-emerald-600 px-4 py-3 text-white font-semibold shadow hover:bg-emerald-500 active:scale-[0.99]">
          Export data
        </button>
        <button id="clearBtn"
          class="w-full rounded-2xl bg-red-600 px-4 py-3 text-white font-semibold shadow hover:bg-red-500 active:scale-[0.99]">
          Clear all data
        </button>
      </div>
    </section>

    <!-- Empty State -->
    <p id="emptyState" class="mt-4 text-center text-sm text-slate-500 dark:text-slate-400 hidden">
      No reads yet — tap <span class="font-semibold">Add data</span> to create your first entry.
    </p>
  </div>

  <!-- Add Modal -->
  <div id="modalAdd" class="fixed inset-0 z-50 hidden items-end sm:items-center justify-center">
    <div data-backdrop class="absolute inset-0 bg-black/50"></div>

    <div class="relative w-full sm:max-w-md sm:rounded-3xl sm:shadow-xl sm:ring-1 sm:ring-black/10
                bg-white dark:bg-slate-900 rounded-t-3xl p-5 sm:p-6">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg font-semibold">Add Meter Read</h3>
        <button data-close class="rounded-full p-2 hover:bg-slate-100 dark:hover:bg-slate-800">
          <span aria-hidden="true">✕</span>
        </button>
      </div>

      <form id="readForm" class="space-y-3">
        <div>
          <label class="block text-sm mb-1" for="locationSelect">Location</label>
          <select id="locationSelect" required
                  class="w-full rounded-2xl border border-slate-300 dark:border-slate-700 bg-white/80 dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <!-- populated live; default will include custom option -->
          </select>
          <div id="customLocationWrap" class="mt-2 hidden">
            <input id="customLocationInput" placeholder="Enter new location name"
                   class="w-full rounded-2xl border border-slate-300 dark:border-slate-700 bg-white/80 dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
            <p class="mt-1 text-xs text-slate-500">This new location will be saved for future use.</p>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm mb-1" for="date">Date</label>
            <input id="date" type="date" required
                   class="w-full rounded-2xl border border-slate-300 dark:border-slate-700 bg-white/80 dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          </div>

          <div>
            <label class="block text-sm mb-1" for="value">Meter Read</label>
            <input id="value" type="number" required step="any" min="0" placeholder="e.g., 1278.3"
                   class="w-full rounded-2xl border border-slate-300 dark:border-slate-700 bg-white/80 dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          </div>
        </div>

        <div class="flex items-center justify-between pt-2">
          <div id="formMsg" class="text-sm"></div>
          <button id="saveBtn" type="submit"
            class="rounded-2xl bg-indigo-600 px-4 py-2 text-white font-semibold shadow hover:bg-indigo-500 active:scale-[0.99] disabled:opacity-60">
            Save
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Export Modal -->
  <div id="modalExport" class="fixed inset-0 z-50 hidden items-end sm:items-center justify-center">
    <div data-backdrop class="absolute inset-0 bg-black/50"></div>

    <div class="relative w-full sm:max-w-md sm:rounded-3xl sm:shadow-xl sm:ring-1 sm:ring-black/10
                bg-white dark:bg-slate-900 rounded-t-3xl p-5 sm:p-6">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg font-semibold">Export Data</h3>
        <button data-close class="rounded-full p-2 hover:bg-slate-100 dark:hover:bg-slate-800">
          <span aria-hidden="true">✕</span>
        </button>
      </div>

      <form id="exportForm" class="space-y-3">
        <div>
          <label class="block text-sm mb-1" for="exportLocation">Location</label>
          <select id="exportLocation"
                  class="w-full rounded-2xl border border-slate-300 dark:border-slate-700 bg-white/80 dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500">
            <!-- populated live; includes "All locations" -->
          </select>
        </div>

        <div>
          <label class="block text-sm mb-1" for="exportRange">Timeframe</label>
          <select id="exportRange"
                  class="w-full rounded-2xl border border-slate-300 dark:border-slate-700 bg-white/80 dark:bg-slate-800 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500">
            <option value="3">Last 3 months</option>
            <option value="6">Last 6 months</option>
            <option value="9">Last 9 months</option>
            <option value="12" selected>Last 1 year</option>
            <option value="24">Last 2 years</option>
            <option value="all">All time</option>
          </select>
        </div>

        <div class="flex items-center justify-between pt-2">
          <div id="exportMsg" class="text-sm"></div>
          <button id="doExportBtn" type="submit"
            class="rounded-2xl bg-emerald-600 px-4 py-2 text-white font-semibold shadow hover:bg-emerald-500 active:scale-[0.99] disabled:opacity-60">
            Export
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Month Selection Modal -->
  <div id="modalMonthSelect" class="fixed inset-0 z-50 hidden items-end sm:items-center justify-center">
    <div data-backdrop class="absolute inset-0 bg-black/50"></div>
    <div class="relative w-full sm:max-w-md sm:rounded-3xl sm:shadow-xl sm:ring-1 sm:ring-black/10
                bg-white dark:bg-slate-900 rounded-t-3xl p-5 sm:p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">Select Month to Export</h3>
        <button data-close class="rounded-full p-2 hover:bg-slate-100 dark:hover:bg-slate-800">
          <span aria-hidden="true">✕</span>
        </button>
      </div>
      <form id="monthSelectForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
            Select Month:
          </label>
          <select id="monthSelect" class="w-full rounded-2xl border border-slate-300 dark:border-slate-600 
                        bg-white dark:bg-slate-800 px-4 py-3 text-sm focus:outline-none focus:ring-2 
                        focus:ring-blue-500 focus:border-transparent">
            <option value="0">January</option>
            <option value="1">February</option>
            <option value="2">March</option>
            <option value="3">April</option>
            <option value="4">May</option>
            <option value="5">June</option>
            <option value="6">July</option>
            <option value="7">August</option>
            <option value="8">September</option>
            <option value="9">October</option>
            <option value="10">November</option>
            <option value="11">December</option>
          </select>
        </div>
        <div class="flex items-center justify-between pt-4 border-t border-slate-200 dark:border-slate-700">
          <div id="monthSelectMsg" class="text-sm"></div>
          <button type="submit" id="exportMonthBtn"
            class="rounded-2xl bg-emerald-600 px-4 py-2 text-white font-semibold shadow hover:bg-emerald-500 
                   active:scale-[0.99] disabled:opacity-60">
            Export Data
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Location Data Modal -->
  <div id="modalEditLocation" class="fixed inset-0 z-50 hidden items-end sm:items-center justify-center">
    <div data-backdrop class="absolute inset-0 bg-black/50"></div>

    <div class="relative w-full sm:max-w-2xl sm:rounded-3xl sm:shadow-xl sm:ring-1 sm:ring-black/10
                bg-white dark:bg-slate-900 rounded-t-3xl p-5 sm:p-6 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">Edit Location Data</h3>
        <div class="flex items-center gap-2">
          <input type="file" id="importJsonFile" accept=".json" class="hidden" />
          <button id="importJsonBtn" class="rounded-xl bg-blue-600 px-3 py-2 text-white text-sm font-medium shadow hover:bg-blue-500 active:scale-[0.99]">
            Import JSON
          </button>
          <button data-close class="rounded-full p-2 hover:bg-slate-100 dark:hover:bg-slate-800">
            <span aria-hidden="true">✕</span>
          </button>
        </div>
      </div>

      <div id="locationList" class="space-y-4">
        <!-- Locations will be populated here -->
      </div>

      <div class="flex items-center justify-between pt-4 border-t border-slate-200 dark:border-slate-700">
        <div id="editLocationMsg" class="text-sm"></div>
        <button id="saveLocationBtn"
          class="rounded-2xl bg-purple-600 px-4 py-2 text-white font-semibold shadow hover:bg-purple-500 active:scale-[0.99] disabled:opacity-60">
          Save All Changes
        </button>
      </div>
    </div>
  </div>

  <!-- JSON Paste Modal -->
  <div id="modalJsonPaste" class="fixed inset-0 z-50 hidden items-end sm:items-center justify-center">
    <div data-backdrop class="absolute inset-0 bg-black/50"></div>

    <div class="relative w-full sm:max-w-2xl sm:rounded-3xl sm:shadow-xl sm:ring-1 sm:ring-black/10
                bg-white dark:bg-slate-900 rounded-t-3xl p-5 sm:p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">Import Location JSON</h3>
        <button data-close class="rounded-full p-2 hover:bg-slate-100 dark:hover:bg-slate-800">
          <span aria-hidden="true">✕</span>
        </button>
      </div>

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
            Paste your JSON data below:
          </label>
          <textarea id="jsonPasteTextarea" 
                    placeholder="Paste your JSON array here..."
                    class="w-full h-64 rounded-2xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 px-4 py-3 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
        </div>

        <div class="flex items-center justify-between">
          <div id="jsonPasteMsg" class="text-sm"></div>
          <div class="flex gap-2">
            <button id="cancelJsonPasteBtn" class="rounded-xl bg-slate-500 px-4 py-2 text-white text-sm font-medium shadow hover:bg-slate-400 active:scale-[0.99]">
              Cancel
            </button>
            <button id="processJsonBtn" class="rounded-xl bg-blue-600 px-4 py-2 text-white text-sm font-medium shadow hover:bg-blue-500 active:scale-[0.99] disabled:opacity-60">
              Import Data
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Overwrite Confirmation Modal -->
  <div id="modalOverwrite" class="fixed inset-0 z-50 hidden items-end sm:items-center justify-center">
    <div data-backdrop class="absolute inset-0 bg-black/50"></div>

    <div class="relative w-full sm:max-w-md sm:rounded-3xl sm:shadow-xl sm:ring-1 sm:ring-black/10
                bg-white dark:bg-slate-900 rounded-t-3xl p-6">
      <button data-close class="absolute top-4 right-4 rounded-full p-2 hover:bg-slate-100 dark:hover:bg-slate-800">
        <span aria-hidden="true">✕</span>
      </button>
      <div class="text-center">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-amber-100 dark:bg-amber-900/20 mb-4">
          <svg class="h-6 w-6 text-amber-600 dark:text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
          </svg>
        </div>
        
        <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100 mb-2">
          Duplicate Entry Found
        </h3>
        
        <p class="text-sm text-slate-600 dark:text-slate-400 mb-6">
          There's already a meter reading for <span id="overwriteLocationName" class="font-semibold"></span> in <span id="overwriteMonthYear" class="font-semibold"></span>.
          <br><br>
          Would you like to overwrite the existing data?
        </p>

        <div class="flex gap-3 justify-center">
          <button id="cancelOverwriteBtn" class="rounded-xl bg-slate-500 px-6 py-2 text-white text-sm font-medium shadow hover:bg-slate-400 active:scale-[0.99]">
            Cancel
          </button>
          <button id="confirmOverwriteBtn" class="rounded-xl bg-amber-600 px-6 py-2 text-white text-sm font-medium shadow hover:bg-amber-500 active:scale-[0.99]">
            Overwrite
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/xlsx-populate/browser/xlsx-populate.min.js"></script>

  <!-- Firebase (modular SDK via ESM) -->
  <script type="module">
    // ----- Firebase Setup -----
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, addDoc, onSnapshot, setDoc, doc,
      query, orderBy, serverTimestamp, Timestamp, deleteDoc, getDocs, where
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCMXkAdeC3uqYCl2GtVQAhTQd9zZhuuf2o",
      authDomain: "waterdata-f5be3.firebaseapp.com",
      projectId: "waterdata-f5be3",
      storageBucket: "waterdata-f5be3.firebasestorage.app",
      messagingSenderId: "423248061288",
      appId: "1:423248061288:web:429ceb5b0f542809b82cdd",
      measurementId: "G-1F0GYHGBCC"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const readsRef = collection(db, "reads");
    const locationsRef = collection(db, "locations");

     // ----- UI Elements -----
     const communitySelection = document.getElementById("communitySelection");
     const communityDashboard = document.getElementById("communityDashboard");
     const backToCommunities = document.getElementById("backToCommunities");
     const communitySection = document.getElementById("communitySection");
     const communityCards = document.querySelectorAll(".community-card");
     
     const modalAdd         = document.getElementById("modalAdd");
     const modalExport      = document.getElementById("modalExport");
     const modalMonthSelect = document.getElementById("modalMonthSelect");
     const modalEditLocation = document.getElementById("modalEditLocation");
     const addBtn           = document.getElementById("addBtn");
     const exportBtn        = document.getElementById("exportBtn");
     const clearBtn         = document.getElementById("clearBtn");
     const editLocationBtn  = document.getElementById("editLocationBtn");

    const rangeSelect  = document.getElementById("rangeSelect");
    const emptyState   = document.getElementById("emptyState");

    const readForm     = document.getElementById("readForm");
    const inputDate    = document.getElementById("date");
    const inputValue   = document.getElementById("value");
    const formMsg      = document.getElementById("formMsg");
    const saveBtn      = document.getElementById("saveBtn");

    const locationSelect      = document.getElementById("locationSelect");
    const customLocationWrap  = document.getElementById("customLocationWrap");
    const customLocationInput = document.getElementById("customLocationInput");

    const exportForm     = document.getElementById("exportForm");
    const exportLocation = document.getElementById("exportLocation");
    const exportRange    = document.getElementById("exportRange");
    const exportMsg      = document.getElementById("exportMsg");
    const doExportBtn    = document.getElementById("doExportBtn");

    const monthSelectForm = document.getElementById("monthSelectForm");
    const monthSelect     = document.getElementById("monthSelect");
    const monthSelectMsg  = document.getElementById("monthSelectMsg");
    const exportMonthBtn  = document.getElementById("exportMonthBtn");

    const locationList     = document.getElementById("locationList");
    const editLocationMsg  = document.getElementById("editLocationMsg");
    const saveLocationBtn  = document.getElementById("saveLocationBtn");
    const importJsonFile   = document.getElementById("importJsonFile");
    const importJsonBtn    = document.getElementById("importJsonBtn");
    
    const modalJsonPaste   = document.getElementById("modalJsonPaste");
    const jsonPasteTextarea = document.getElementById("jsonPasteTextarea");
    const jsonPasteMsg     = document.getElementById("jsonPasteMsg");
    const cancelJsonPasteBtn = document.getElementById("cancelJsonPasteBtn");
    const processJsonBtn   = document.getElementById("processJsonBtn");
    
    const modalOverwrite   = document.getElementById("modalOverwrite");
    const overwriteLocationName = document.getElementById("overwriteLocationName");
    const overwriteMonthYear = document.getElementById("overwriteMonthYear");
    const cancelOverwriteBtn = document.getElementById("cancelOverwriteBtn");
    const confirmOverwriteBtn = document.getElementById("confirmOverwriteBtn");

    // ----- Modal helpers -----
    function bindModal(el) {
      const backdrop = el.querySelector("[data-backdrop]");
      const closeBtn = el.querySelector("[data-close]");
      const hide = () => { el.classList.add("hidden"); el.classList.remove("modal-show"); };
      const show = () => { el.classList.add("modal-show"); el.classList.remove("hidden"); };
      return { show, hide, backdrop, closeBtn };
    }
    const addModalCtl = bindModal(modalAdd);
    const exportModalCtl = bindModal(modalExport);
    const monthSelectModalCtl = bindModal(modalMonthSelect);
    const editLocationModalCtl = bindModal(modalEditLocation);
    const jsonPasteModalCtl = bindModal(modalJsonPaste);
    const overwriteModalCtl = bindModal(modalOverwrite);

    addBtn.addEventListener("click", () => { 
      setTodayDate(); // Always set to today when opening modal
      addModalCtl.show(); 
      setTimeout(() => locationSelect.focus(), 0); 
    });
    exportBtn.addEventListener("click", () => {
      // Show month selection modal instead of auto-export
      showMonthSelectionModal();
    });
    editLocationBtn.addEventListener("click", () => { 
      editLocationModalCtl.show(); 
      populateLocationEditList(); 
    });
    
    // JSON Import button - show paste modal instead of file picker
    importJsonBtn.addEventListener("click", () => {
      jsonPasteModalCtl.show();
      setTimeout(() => jsonPasteTextarea.focus(), 0);
    });
    
    // Clear all data functionality
    clearBtn.addEventListener("click", async () => {
      if (!confirm("Are you sure you want to clear ALL data? This action cannot be undone.")) {
        return;
      }
      
      clearBtn.disabled = true;
      clearBtn.textContent = "Clearing...";
      
       try {
         // Get all reads and delete them
         const readsSnapshot = await getDocs(window.currentReadsRef);
         const deletePromises = readsSnapshot.docs.map(docSnap => deleteDoc(docSnap.ref));
         await Promise.all(deletePromises);
         
         // Get all locations and delete them
         const locationsSnapshot = await getDocs(window.currentLocationsRef);
         const locationDeletePromises = locationsSnapshot.docs.map(docSnap => deleteDoc(docSnap.ref));
         await Promise.all(locationDeletePromises);
        
        clearBtn.textContent = "Cleared!";
        setTimeout(() => {
          clearBtn.textContent = "Clear all data";
          clearBtn.disabled = false;
        }, 1500);
        
      } catch (err) {
        console.error("Error clearing data:", err);
        clearBtn.textContent = "Error - try again";
        setTimeout(() => {
          clearBtn.textContent = "Clear all data";
          clearBtn.disabled = false;
        }, 2000);
      }
    });

    [addModalCtl, exportModalCtl, editLocationModalCtl, jsonPasteModalCtl, overwriteModalCtl].forEach(m => {
      if (m && m.backdrop && m.closeBtn) {
        m.backdrop.addEventListener("click", m.hide);
        m.closeBtn.addEventListener("click", m.hide);
      }
    });
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") { addModalCtl.hide(); exportModalCtl.hide(); editLocationModalCtl.hide(); jsonPasteModalCtl.hide(); overwriteModalCtl.hide(); }
    });

    // Default date = today (ensure it's always set)
    function setTodayDate() {
      const today = new Date();
      inputDate.valueAsDate = today;
    }
    setTodayDate();

    // ----- Chart Setup -----
    const ctx = document.getElementById("readsChart").getContext("2d");
    const palette = [
      "#6366f1","#10b981","#f59e0b","#ef4444","#06b6d4",
      "#8b5cf6","#22c55e","#f97316","#e11d48","#14b8a6",
      "#0ea5e9","#84cc16","#a855f7","#f43f5e","#0891b2"
    ];
    const colorFor = (idx) => palette[idx % palette.length];

    let chart = new Chart(ctx, {
      type: "line",
      data: { datasets: [] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "nearest", intersect: false },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const d = ctx.raw;
                return `${ctx.dataset.label}: ${d.y} on ${new Date(d.x).toLocaleDateString()}`;
              }
            }
          }
        },
        scales: {
          x: { 
            type: "time", 
            time: { unit: "day" }, 
            ticks: { 
              maxRotation: 0, 
              autoSkipPadding: 12,
              display: true,
              minRotation: 0
            },
            display: true,
            grid: {
              color: "rgba(0,0,0,0.1)",
              drawBorder: false
            }
          },
          y: { 
            title: { display: true, text: "Meter Read" }, 
            beginAtZero: true,
            grid: {
              color: "rgba(0,0,0,0.1)",
              drawBorder: false
            }
          }
        }
      }
    });

    const legendEl = document.getElementById("legend");
    const renderLegend = () => {
      legendEl.innerHTML = "";
      chart.data.datasets.forEach((ds, i) => {
        const btn = document.createElement("button");
        btn.className = "flex items-center gap-2 rounded-2xl px-3 py-2 text-sm ring-1 ring-slate-200 dark:ring-slate-700 bg-white/70 dark:bg-slate-900/40";
        btn.innerHTML = `
          <span class="inline-block h-3 w-3 rounded-full" style="background:${ds.borderColor}"></span>
          <span>${ds.label}</span>
        `;
         btn.onclick = () => {
           // Open add data modal with this location pre-selected
           locationSelect.value = ds.label;
           setTodayDate(); // Always set to today when opening modal
           addModalCtl.show();
           setTimeout(() => locationSelect.focus(), 0);
         };
        legendEl.appendChild(btn);
      });
    };

     // ----- Community Management -----
     let currentCommunity = null;
     const communityNames = {
       "mesa-del-toro": "Mesa Del Toro",
       "alba": "Alba", 
       "lhoist": "Lhoist",
       "linda-vista": "Linda Vista"
     };

     // Community switching functions
     function switchToCommunity(communityId) {
       currentCommunity = communityId;
       const communityName = communityNames[communityId];
       
       // Update the community section title
       const titleElement = communitySection.querySelector("h1");
       titleElement.textContent = communityName;
       
       // Show dashboard, hide selection
       communitySelection.classList.add("hidden");
       communityDashboard.classList.remove("hidden");
       
       // Load community data
       loadCommunityData(communityId);
     }

     function switchToCommunitySelection() {
       currentCommunity = null;
       communityDashboard.classList.add("hidden");
       communitySelection.classList.remove("hidden");
     }

     function loadCommunityData(communityId) {
       // Update Firebase references for this community
       const communityReadsRef = collection(db, `communities/${communityId}/reads`);
       const communityLocationsRef = collection(db, `communities/${communityId}/locations`);
       
       // Update global references
       window.currentReadsRef = communityReadsRef;
       window.currentLocationsRef = communityLocationsRef;
       
       // Clear existing data
       allDocs = [];
       allLocations = [];
       
       // Load new data
       loadCommunityReads(communityReadsRef);
       loadCommunityLocations(communityLocationsRef);
     }

     function loadCommunityReads(readsRef) {
       const qReads = query(readsRef, orderBy("date", "asc"), orderBy("location", "asc"));
       onSnapshot(qReads, (snap) => {
         allDocs = snap.docs.map(docSnap => {
           const d = docSnap.data();
           const jsDate = d.date instanceof Timestamp ? d.date.toDate() : new Date(d.date);
           jsDate.setHours(12, 0, 0, 0);
           return {
             id: docSnap.id,
             location: d.location || "Unknown",
             value: Number(d.value) || 0,
             date: jsDate
           };
         });
         applyRange(rangeSelect.value);
       });
     }

     function loadCommunityLocations(locationsRef) {
       const qLocations = query(locationsRef, orderBy("name", "asc"));
       onSnapshot(qLocations, (snap) => {
         allLocations = snap.docs.map(d => ({ id: d.id, ...d.data() }));
         populateLocationSelects();
       });
     }

     // Community card event listeners
     communityCards.forEach(card => {
       card.addEventListener("click", () => {
         const communityId = card.dataset.community;
         switchToCommunity(communityId);
       });
     });

     // Back button event listener
     backToCommunities.addEventListener("click", switchToCommunitySelection);

     // ----- Data state -----
     let allDocs = [];
     let allLocations = []; // array of { id, name, lot, owner, address, meterNumber, lastRead, unit }

    function withinRange(date, days) {
      if (days === "all") return true;
      const now = new Date();
      const start = new Date(now);
      start.setDate(now.getDate() - Number(days));
      return date >= start && date <= now;
    }

    function regroupAndRender(docs) {
      const byLocation = new Map();
      docs.forEach(d => {
        const { location, date, value } = d;
        if (!byLocation.has(location)) byLocation.set(location, []);
        byLocation.get(location).push({ x: date, y: value });
      });

      const datasets = [];
      let i = 0;
      for (const [location, points] of byLocation.entries()) {
        points.sort((a, b) => a.x - b.x);
        datasets.push({
          label: location,
          data: points,
          borderColor: colorFor(i),
          backgroundColor: colorFor(i) + "22",
          borderWidth: 2,
          pointRadius: 3,
          tension: 0.25,
          fill: false
        });
        i++;
      }

      chart.data.datasets = datasets;
      chart.update();
      renderLegend();

      emptyState.classList.toggle("hidden", docs.length > 0);
    }

    function applyRange(days) {
      const filtered = allDocs.filter(d => withinRange(d.date, days));
      regroupAndRender(filtered);
    }

    rangeSelect.addEventListener("change", (e) => applyRange(e.target.value));

     // ----- Firestore listeners -----
     // Note: Firebase listeners are now handled per-community in loadCommunityData()

    function slugify(name) {
      return name.trim().toLowerCase()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "")
        .slice(0, 60) || "loc";
    }

    function populateLocationSelects() {
      // For Add form
      const customValue = "__custom__";
      const opts = [];
      if (allLocations.length === 0) {
        opts.push(new Option("Add custom location…", customValue));
      } else {
        opts.push(new Option("Select location…", "", true, true));
        allLocations.forEach(l => opts.push(new Option(l.name, l.name)));
        opts.push(new Option("Add custom location…", customValue));
      }
      locationSelect.innerHTML = "";
      opts.forEach(o => locationSelect.add(o));

      // For Export form
      const expOpts = [new Option("All locations", "__all__", true, true)];
      allLocations.forEach(l => expOpts.push(new Option(l.name, l.name)));
      exportLocation.innerHTML = "";
      expOpts.forEach(o => exportLocation.add(o));

      // Toggle custom input visibility if needed
      toggleCustomLocation(locationSelect.value === customValue);
    }

    function toggleCustomLocation(show) {
      customLocationWrap.classList.toggle("hidden", !show);
      if (show) setTimeout(() => customLocationInput.focus(), 0);
      if (!show) customLocationInput.value = "";
    }

    locationSelect.addEventListener("change", (e) => {
      toggleCustomLocation(e.target.value === "__custom__");
    });

    // ----- Duplicate Check Functions -----
    async function checkForDuplicate(location, date) {
      const jsDate = new Date(date);
      const year = jsDate.getFullYear();
      const month = jsDate.getMonth();
      
      // Check if there's already data for this location in this month/year
      const existingReads = allDocs.filter(doc => {
        const docDate = new Date(doc.date);
        return doc.location === location && 
               docDate.getFullYear() === year && 
               docDate.getMonth() === month;
      });
      
      return existingReads.length > 0 ? existingReads[0] : null;
    }

    function showOverwriteModal(location, date, existingData) {
      const jsDate = new Date(date);
      const monthYear = jsDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
      
      overwriteLocationName.textContent = location;
      overwriteMonthYear.textContent = monthYear;
      
      // Store the form data for later use
      window.pendingFormData = {
        location: location,
        value: Number(inputValue.value),
        date: date,
        existingData: existingData
      };
      
      overwriteModalCtl.show();
    }

    // Overwrite modal event listeners
    cancelOverwriteBtn.addEventListener("click", () => {
      overwriteModalCtl.hide();
      delete window.pendingFormData;
    });

    confirmOverwriteBtn.addEventListener("click", async () => {
      if (!window.pendingFormData) return;
      
      overwriteModalCtl.hide();
      await processFormSubmission(window.pendingFormData, true);
      delete window.pendingFormData;
    });

    // Process form submission (shared logic)
    async function processFormSubmission(formData, isOverwrite = false) {
      formMsg.textContent = "";
      saveBtn.disabled = true;

      try {
        let location = formData.location;
        
        // Handle custom location creation
        if (location === "__custom__") {
          const custom = (customLocationInput.value || "").trim();
          if (!custom) throw new Error("Please enter a custom location name.");
          location = custom;

           // Persist this location (id is a slug to dedupe)
           const id = slugify(location);
           await setDoc(doc(window.currentLocationsRef, id), { name: location, createdAt: serverTimestamp() }, { merge: true });
        } else if (!location) {
          throw new Error("Please select a location.");
        }

        const value = formData.value;
        const dateStr = formData.date;
        if (!dateStr || !isFinite(value)) {
          throw new Error("Please fill all fields with valid values.");
        }

        const [y, m, d] = dateStr.split("-").map(Number);
        const jsDate = new Date(y, m - 1, d, 12, 0, 0);

         if (isOverwrite && formData.existingData) {
           // Update existing document
           await setDoc(doc(window.currentReadsRef, formData.existingData.id), {
             location,
             value,
             date: Timestamp.fromDate(jsDate),
             updatedAt: serverTimestamp()
           });
         } else {
           // Add new document
           await addDoc(window.currentReadsRef, {
             location,
             value,
             date: Timestamp.fromDate(jsDate),
             createdAt: serverTimestamp()
           });
         }

        formMsg.className = "text-sm text-emerald-600";
        formMsg.textContent = isOverwrite ? "Updated!" : "Saved!";
        setTimeout(() => { addModalCtl.hide(); readForm.reset(); setTodayDate(); }, 350);
      } catch (err) {
        formMsg.className = "text-sm text-rose-600";
        formMsg.textContent = err.message || "Failed to save.";
        saveBtn.disabled = false;
        return;
      }

      saveBtn.disabled = false;
    }

    // ----- Add form -----
    readForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      // Determine final location
      let location = locationSelect.value;
      if (location === "__custom__") {
        const custom = (customLocationInput.value || "").trim();
        if (!custom) {
          formMsg.className = "text-sm text-rose-600";
          formMsg.textContent = "Please enter a custom location name.";
          return;
        }
        location = custom;
      } else if (!location) {
        formMsg.className = "text-sm text-rose-600";
        formMsg.textContent = "Please select a location.";
        return;
      }

      const value = Number(inputValue.value);
      const dateStr = inputDate.value;
      if (!dateStr || !isFinite(value)) {
        formMsg.className = "text-sm text-rose-600";
        formMsg.textContent = "Please fill all fields with valid values.";
        return;
      }

      // Check for duplicate
      const existingData = await checkForDuplicate(location, dateStr);
      if (existingData) {
        showOverwriteModal(location, dateStr, existingData);
        return;
      }

      // No duplicate, proceed with normal submission
      await processFormSubmission({ location, value, date: dateStr });
    });

    // ----- Export -----
    exportForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      exportMsg.textContent = "";
      doExportBtn.disabled = true;

      try {
        const locFilter = exportLocation.value; // "__all__" or specific name
        const months    = exportRange.value;

        let filtered;
        if (months === "all") {
          filtered = allDocs.filter(d => (locFilter === "__all__") ? true : (d.location === locFilter));
        } else {
          const now = new Date();
          const start = new Date(now);
          start.setDate(1);
          start.setMonth(now.getMonth() - Number(months));
          start.setHours(0,0,0,0);
          now.setHours(23,59,59,999);

          filtered = allDocs.filter(d => {
            const t = new Date(d.date);
            t.setHours(12,0,0,0);
            const inTime = t >= start && t <= now;
            const inLoc  = (locFilter === "__all__") ? true : (d.location === locFilter);
            return inTime && inLoc;
          });
        }

        if (!filtered.length) throw new Error("No data matches the selected filters.");

        const rows = filtered
          .sort((a,b) => a.date - b.date)
          .map(d => ({
            Date: d.date.toISOString().slice(0,10),
            Location: d.location,
            "Meter Read": d.value
          }));

        const locPart = (locFilter === "__all__") ? "all" : slugify(locFilter);
        const fname   = `meter_reads_${locPart}_${months}mo.xlsx`;

        await exportStyledXlsx({ rows, filename: fname, title: "Meter Reads" });

        exportMsg.className = "text-sm text-emerald-600";
        exportMsg.textContent = "Exported.";
        setTimeout(() => { exportModalCtl.hide(); }, 350);
      } catch (err) {
        exportMsg.className = "text-sm text-rose-600";
        exportMsg.textContent = err.message || "Export failed.";
        doExportBtn.disabled = false;
        return;
      }

      doExportBtn.disabled = false;
    });

    // Month selection form
    monthSelectForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      monthSelectMsg.textContent = "";
      exportMonthBtn.disabled = true;

      try {
        const selectedMonth = parseInt(monthSelect.value);
        await exportDataForMonth(selectedMonth);
        
        monthSelectModalCtl.hide();
        monthSelectMsg.textContent = "";
      } catch (err) {
        monthSelectMsg.className = "text-sm text-rose-600";
        monthSelectMsg.textContent = err.message || "Export failed.";
      }

      exportMonthBtn.disabled = false;
    });

    // --- Styled Excel export (xlsx-populate) ---
    async function exportStyledXlsx({ rows, filename, title = "Meter Reads" }) {
      const X = window.XlsxPopulate;                         // from the script tag
      const wb = await X.fromBlankAsync();
      const sheet = wb.sheet(0).name("MeterReads");

      // Build headers from row keys
      const headers = rows.length ? Object.keys(rows[0]) : ["Date","Location","Meter Read"];
      const HEADER_ROW = 1, START_COL = 1;

      // Write header row
      headers.forEach((h, i) => sheet.cell(HEADER_ROW, START_COL + i).value(h));

      // Write body rows
      rows.forEach((r, ri) => {
        headers.forEach((h, ci) => sheet.cell(HEADER_ROW + 1 + ri, START_COL + ci).value(r[h] ?? ""));
      });

      // Fit column widths to content
      headers.forEach((h, i) => {
        const col = START_COL + i;
        const maxLen = Math.max(String(h).length, ...rows.map(r => String(r[h] ?? "").length));
        sheet.column(col).width(Math.min(Math.max(maxLen + 2, 10), 40));
      });

      const lastRow = HEADER_ROW + rows.length;
      const lastCol = START_COL + headers.length - 1;

      // Table-style formatting with borders
      sheet.range(HEADER_ROW, START_COL, lastRow, lastCol).style({
        fontFamily: "Arial",
        fontSize: 10,
        verticalAlignment: "center",
        border: {
          top: { style: "thin", color: "D0D0D0" },
          bottom: { style: "thin", color: "D0D0D0" },
          left: { style: "thin", color: "D0D0D0" },
          right: { style: "thin", color: "D0D0D0" }
        }
      });

      // Dark green header with white text (like Google Sheets table)
      sheet.range(HEADER_ROW, START_COL, HEADER_ROW, lastCol).style({
        bold: true,
        fontSize: 11,
        fill: "2D5A27", // Dark green
        fontColor: "FFFFFF", // White text
        horizontalAlignment: "center",
        verticalAlignment: "center"
      });

      // Alternating row colors (white and light gray)
      for (let r = HEADER_ROW + 1; r <= lastRow; r++) {
        const isEvenRow = (r - HEADER_ROW) % 2 === 0;
        sheet.range(r, START_COL, r, lastCol).style({ 
          fill: isEvenRow ? "F5F5F5" : "FFFFFF" // Light gray and white alternating
        });
      }

      // Table-style alignment and formatting
      const colIndex = name => headers.indexOf(name);
      
      // Lot column - left aligned
      const lotIdx = colIndex("Lot");
      if (lotIdx >= 0) sheet.column(START_COL + lotIdx).style({
        horizontalAlignment: "left"
      });

      // Owner and Address columns - left aligned
      ["Owner", "Address"].forEach(k => {
        const idx = colIndex(k);
        if (idx >= 0) sheet.column(START_COL + idx).style({
          horizontalAlignment: "left"
        });
      });

      // METER # column - left aligned
      const meterIdx = colIndex("METER #");
      if (meterIdx >= 0) sheet.column(START_COL + meterIdx).style({
        horizontalAlignment: "left"
      });

      // LAST READ column - right aligned with number formatting
      const lastReadIdx = colIndex("LAST READ");
      if (lastReadIdx >= 0) sheet.column(START_COL + lastReadIdx).style({
        horizontalAlignment: "right",
        numberFormat: "#,##0"
      });

      // Month column (September, October, etc.) - right aligned
      const monthColumns = headers.filter(h => h !== "Lot" && h !== "Owner" && h !== "Address" && h !== "METER #" && h !== "LAST READ" && h !== "UNITS");
      monthColumns.forEach(monthCol => {
        const idx = colIndex(monthCol);
        if (idx >= 0) sheet.column(START_COL + idx).style({
          horizontalAlignment: "right",
          numberFormat: "#,##0"
        });
      });

      // UNITS column - left aligned
      const unitsIdx = colIndex("UNITS");
      if (unitsIdx >= 0) sheet.column(START_COL + unitsIdx).style({
        horizontalAlignment: "left"
      });

      // Freeze header (autoFilter removed due to compatibility issues)
      sheet.freezePanes(2, 1);

      // Download file
      const blob = await wb.outputAsync();
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename.endsWith(".xlsx") ? filename : `${filename}.xlsx`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // ----- Month Selection and Export Functions -----
    function showMonthSelectionModal() {
      // Set current month as default selection
      const now = new Date();
      monthSelect.value = now.getMonth();
      monthSelectModalCtl.show();
    }

    async function exportDataForMonth(selectedMonth) {
      try {
        const now = new Date();
        const currentYear = now.getFullYear();
        const monthName = new Date(2024, selectedMonth, 1).toLocaleDateString('en-US', { month: 'long' });
        
        // Calculate previous month
        const previousMonth = selectedMonth === 0 ? 11 : selectedMonth - 1;
        const previousYear = selectedMonth === 0 ? currentYear - 1 : currentYear;
        
         // Get all locations
         const locationsSnapshot = await getDocs(window.currentLocationsRef);
         const allLocations = locationsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        
        // Get meter readings for selected month (current month data)
        const currentMonthReads = allDocs.filter(doc => {
          const docDate = new Date(doc.date);
          return docDate.getMonth() === selectedMonth && docDate.getFullYear() === currentYear;
        });
        
        // Get meter readings for previous month (LAST READ data)
        const previousMonthReads = allDocs.filter(doc => {
          const docDate = new Date(doc.date);
          return docDate.getMonth() === previousMonth && docDate.getFullYear() === previousYear;
        });
        
        // Create maps for quick lookup
        const currentMonthMap = new Map();
        currentMonthReads.forEach(read => {
          currentMonthMap.set(read.location, read.value);
        });
        
        const previousMonthMap = new Map();
        previousMonthReads.forEach(read => {
          previousMonthMap.set(read.location, read.value);
        });
        
        // Build Excel data with dynamic month column and previous month as LAST READ
        const rows = allLocations.map((location, index) => ({
          "Lot": (index + 1).toString(),
          "Owner": location.owner || "",
          "Address": location.address || location.name || "",
          "METER #": location.meterNumber || "",
          "LAST READ": previousMonthMap.get(location.name) || "",
          [monthName]: currentMonthMap.get(location.name) || "",
          "UNITS": location.unit || ""
        }));

        await exportStyledXlsx({
          rows,
          filename: `water_meter_reads_${monthName.toLowerCase()}_${currentYear}.xlsx`,
          title: `Water Meter Reads – ${monthName} ${currentYear}`
        });

        // Button success flash
        const originalText = exportBtn.textContent;
        exportBtn.textContent = "Downloaded!";
        exportBtn.classList.replace("bg-emerald-600","bg-green-600");
        exportBtn.classList.replace("hover:bg-emerald-500","hover:bg-green-500");
        setTimeout(() => {
          exportBtn.textContent = originalText;
          exportBtn.classList.replace("bg-green-600","bg-emerald-600");
          exportBtn.classList.replace("hover:bg-green-500","hover:bg-emerald-500");
        }, 1600);

      } catch (err) {
        console.error("Export failed:", err);
        alert("Failed to export data. Please try again.");
      }
    }

    // ----- Auto Export Current Month Data -----
    async function exportCurrentMonthData() {
      try {
        const now         = new Date();
        const currentMon  = now.getMonth();
        const currentYear = now.getFullYear();
        const monthName   = now.toLocaleDateString('en-US', { month: 'long' });

        // Map current-month reads: location -> value
        const curReads = allDocs.filter(doc => {
          const d = new Date(doc.date);
          return d.getMonth() === currentMon && d.getFullYear() === currentYear;
        });
        const readsMap = new Map(curReads.map(r => [r.location, r.value]));

        // Build rows in the order of your locations list
        const rows = allLocations.map((loc, i) => ({
          "Lot": (i + 1).toString(),
          "Owner": loc.owner || "",
          "Address": loc.address || loc.name || "",
          "METER #": loc.meterNumber || "",
          "LAST READ": loc.lastRead || "",
          [`${monthName}-${String(now.getDate()).padStart(2,"0")}`]: readsMap.get(loc.name) ?? "",
          "UNITS": loc.unit || ""
        }));

        await exportStyledXlsx({
          rows,
          filename: `water_meter_reads_${monthName.toLowerCase()}_${currentYear}.xlsx`,
          title: `Water Meter Reads – ${monthName} ${currentYear}`
        });

        // Button success flash
        const originalText = exportBtn.textContent;
        exportBtn.textContent = "Downloaded!";
        exportBtn.classList.replace("bg-emerald-600","bg-green-600");
        exportBtn.classList.replace("hover:bg-emerald-500","hover:bg-green-500");
        setTimeout(() => {
          exportBtn.textContent = originalText;
          exportBtn.classList.replace("bg-green-600","bg-emerald-600");
          exportBtn.classList.replace("hover:bg-green-500","hover:bg-emerald-500");
        }, 1600);
      } catch (err) {
        console.error("Export failed:", err);
        alert("Failed to export data. Please try again.");
      }
    }

    // ----- Location Edit Functions -----
    function populateLocationEditList() {
      locationList.innerHTML = "";
      
      if (allLocations.length === 0) {
        locationList.innerHTML = '<p class="text-center text-slate-500 dark:text-slate-400 py-8">No locations found. Add some data first!</p>';
        return;
      }

      allLocations.forEach(location => {
        const locationCard = document.createElement("div");
        locationCard.className = "bg-slate-50 dark:bg-slate-800 rounded-2xl p-4 border border-slate-200 dark:border-slate-700";
        locationCard.innerHTML = `
          <div class="flex items-center justify-between mb-3">
            <h4 class="font-semibold text-slate-800 dark:text-slate-200">${location.name}</h4>
            <div class="flex items-center gap-2">
              <span class="text-xs text-slate-500 dark:text-slate-400">ID: ${location.id}</span>
              <button class="delete-location-btn rounded-lg bg-red-500 px-3 py-1 text-white text-xs font-medium shadow hover:bg-red-600 active:scale-[0.98]" 
                      data-location-id="${location.id}" data-location-name="${location.name}">
                Delete
              </button>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-medium text-slate-600 dark:text-slate-400 mb-1">Lot</label>
              <input type="text" data-location-id="${location.id}" data-field="lot" 
                     value="${location.lot || ''}" placeholder="Enter lot number"
                     class="w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-600 dark:text-slate-400 mb-1">Owner</label>
              <input type="text" data-location-id="${location.id}" data-field="owner" 
                     value="${location.owner || ''}" placeholder="Enter owner name"
                     class="w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-600 dark:text-slate-400 mb-1">Address</label>
              <input type="text" data-location-id="${location.id}" data-field="address" 
                     value="${location.address || ''}" placeholder="Enter address"
                     class="w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-600 dark:text-slate-400 mb-1">Meter #</label>
              <input type="text" data-location-id="${location.id}" data-field="meterNumber" 
                     value="${location.meterNumber || ''}" placeholder="Enter meter number"
                     class="w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-600 dark:text-slate-400 mb-1">Last Read</label>
              <input type="number" step="any" data-location-id="${location.id}" data-field="lastRead" 
                     value="${location.lastRead || ''}" placeholder="Enter last read value"
                     class="w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-600 dark:text-slate-400 mb-1">Unit</label>
              <input type="text" data-location-id="${location.id}" data-field="unit" 
                     value="${location.unit || ''}" placeholder="Enter unit type"
                     class="w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" />
            </div>
          </div>
        `;
        locationList.appendChild(locationCard);
      });

      // Add event listeners to delete buttons
      locationList.querySelectorAll('.delete-location-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const locationId = e.target.dataset.locationId;
          const locationName = e.target.dataset.locationName;
          
          if (confirm(`Are you sure you want to delete "${locationName}"? This will also delete all meter readings for this location. This action cannot be undone.`)) {
            await deleteLocation(locationId, locationName);
          }
        });
      });
    }

     // Delete location function
     async function deleteLocation(locationId, locationName) {
       try {
         // Delete all meter readings for this location first
         const readsQuery = query(window.currentReadsRef, where("location", "==", locationName));
         const readsSnapshot = await getDocs(readsQuery);
         const deleteReadsPromises = readsSnapshot.docs.map(docSnap => deleteDoc(docSnap.ref));
         await Promise.all(deleteReadsPromises);

         // Delete the location itself
         await deleteDoc(doc(window.currentLocationsRef, locationId));

        // Refresh the location list
        populateLocationEditList();

        editLocationMsg.className = "text-sm text-emerald-600";
        editLocationMsg.textContent = `Successfully deleted "${locationName}" and all associated meter readings.`;

        setTimeout(() => {
          editLocationMsg.textContent = "";
        }, 3000);

      } catch (err) {
        console.error("Error deleting location:", err);
        editLocationMsg.className = "text-sm text-rose-600";
        editLocationMsg.textContent = `Failed to delete "${locationName}". Please try again.`;
      }
    }

    // Save location changes
    saveLocationBtn.addEventListener("click", async () => {
      saveLocationBtn.disabled = true;
      saveLocationBtn.textContent = "Saving...";
      editLocationMsg.textContent = "";

      try {
        const inputs = locationList.querySelectorAll("input[data-location-id]");
        const updates = {};

        // Group inputs by location ID
        inputs.forEach(input => {
          const locationId = input.dataset.locationId;
          const field = input.dataset.field;
          const value = input.value.trim();

          if (!updates[locationId]) {
            updates[locationId] = {};
          }
          updates[locationId][field] = value || "";
        });

         // Update each location in Firebase
         const updatePromises = Object.entries(updates).map(([locationId, data]) => {
           return setDoc(doc(window.currentLocationsRef, locationId), {
             ...data,
             updatedAt: serverTimestamp()
           }, { merge: true });
         });

        await Promise.all(updatePromises);

        editLocationMsg.className = "text-sm text-emerald-600";
        editLocationMsg.textContent = "All changes saved successfully!";
        
        setTimeout(() => {
          editLocationModalCtl.hide();
          editLocationMsg.textContent = "";
        }, 1500);

      } catch (err) {
        console.error("Error saving location data:", err);
        editLocationMsg.className = "text-sm text-rose-600";
        editLocationMsg.textContent = "Failed to save changes. Please try again.";
      }

      saveLocationBtn.disabled = false;
      saveLocationBtn.textContent = "Save All Changes";
    });

    // ----- JSON Import Functionality -----
    // Cancel button
    cancelJsonPasteBtn.addEventListener("click", () => {
      jsonPasteModalCtl.hide();
      jsonPasteTextarea.value = "";
      jsonPasteMsg.textContent = "";
    });

    // Process JSON from textarea
    processJsonBtn.addEventListener("click", async () => {
      const jsonText = jsonPasteTextarea.value.trim();
      if (!jsonText) {
        jsonPasteMsg.className = "text-sm text-rose-600";
        jsonPasteMsg.textContent = "Please paste some JSON data first.";
        return;
      }

      await processJsonData(jsonText);
    });

    // Shared function to process JSON data
    async function processJsonData(jsonText) {
      processJsonBtn.disabled = true;
      processJsonBtn.textContent = "Processing...";
      jsonPasteMsg.textContent = "";

      try {
        const jsonData = JSON.parse(jsonText);
        
        // Validate JSON structure
        if (!Array.isArray(jsonData)) {
          throw new Error("JSON must be an array of location objects");
        }

        // Process each location in the JSON
        const processedLocations = [];
        for (const item of jsonData) {
          if (!item.name) {
            console.warn("Skipping item without name:", item);
            continue;
          }

          // Create location object with all properties
          const location = {
            name: item.name,
            lot: item.lot || "",
            owner: item.owner || "",
            address: item.address || "",
            meterNumber: item.meterNumber || item.meter_number || "",
            lastRead: item.lastRead || item.last_read || "",
            unit: item.unit || ""
          };

          // Generate ID from name (same as existing logic)
          const id = slugify(location.name);
          location.id = id;

          processedLocations.push(location);
        }

        if (processedLocations.length === 0) {
          throw new Error("No valid locations found in JSON data");
        }

         // Update Firebase with imported data
         const updatePromises = processedLocations.map(location => {
           return setDoc(doc(window.currentLocationsRef, location.id), {
             name: location.name,
             lot: location.lot,
             owner: location.owner,
             address: location.address,
             meterNumber: location.meterNumber,
             lastRead: location.lastRead,
             unit: location.unit,
             createdAt: serverTimestamp(),
             updatedAt: serverTimestamp()
           }, { merge: true });
         });

        await Promise.all(updatePromises);

        // Process previous reads - create meter reading entries
        const readPromises = [];
        const now = new Date();
        
        for (const item of jsonData) {
          // Check for previousRead first, then fall back to lastRead
          const readValue = item.previousRead || item.lastRead;
          
          if (readValue && !isNaN(parseFloat(readValue))) {
            const readDate = new Date(now); // Use the same base date for all entries
            
            // Both previousRead and lastRead should be set one month ago
            // This creates historical data points for the graph
            readDate.setMonth(now.getMonth() - 1); // One month ago
            
            // Normalize to noon to ensure all entries for the same day group together
            readDate.setHours(12, 0, 0, 0);
            
            const readData = {
              location: item.name,
              value: parseFloat(readValue),
              date: readDate,
              timestamp: serverTimestamp()
            };
            
             // Add the meter reading to Firebase
             readPromises.push(addDoc(window.currentReadsRef, readData));
          }
        }

        if (readPromises.length > 0) {
          await Promise.all(readPromises);
        }

        // Refresh the location list
        populateLocationEditList();

        jsonPasteMsg.className = "text-sm text-emerald-600";
        jsonPasteMsg.textContent = `Successfully imported ${processedLocations.length} location(s)!`;

        // Clear the textarea and close modal
        jsonPasteTextarea.value = "";
        setTimeout(() => {
          jsonPasteModalCtl.hide();
          jsonPasteMsg.textContent = "";
        }, 1500);

      } catch (err) {
        console.error("Error importing JSON:", err);
        jsonPasteMsg.className = "text-sm text-rose-600";
        jsonPasteMsg.textContent = `Import failed: ${err.message}`;
      }

      processJsonBtn.disabled = false;
      processJsonBtn.textContent = "Import Data";
    }

    // File import (keeping as backup)
    importJsonFile.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        await processJsonData(text);
        
        // Clear the file input
        importJsonFile.value = "";
      } catch (err) {
        console.error("Error importing JSON file:", err);
        editLocationMsg.className = "text-sm text-rose-600";
        editLocationMsg.textContent = `Import failed: ${err.message}`;
        
        // Clear the file input
        importJsonFile.value = "";
      }
    });

     // Initialize with community selection screen
     // No need to populate selects until a community is selected
  </script>
</body>
</html>
